<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.wheelingcamp.item.model.mapper.ItemMapper">

		<!--package 한 개 가져오기 resultMap-->
		<resultMap type="Package" id="package_rm">
				<!-- id 태그 : PK 역할을 하는 컬럼, 필드를 작성하는 태그 -->
				<id property="packageNo" column="PACKAGE_NO" />
				<!-- collection 태그
					select로 조회된 결과를 컬렉션(List)에 담아
					지정된 필드에 세팅
					
					property : List를 담을 DTO의 필드명
					select : 실행할 select의 id
					column : 조회 결과 중 지정된 컬럼의 값을 파라미터로 전달
					javaType : List(컬렉션)의 타입을 지정
					ofType : List(컬렉션)의 제네릭(타입 제한) 지정
					-->
			<!--  해당 게시글 이미지 목록 조회 후 필드에 저장  -->
				<collection 
					property="itemList"
					select = "selectOnePackageItemList"
					column = "ITEM_NO"
					javaType="java.util.ArrayList"
					ofType = "Item"
				/>

		</resultMap>


	<!--차 한 대 가져오기-->
	<select id="selectOneCar" resultType="Car">
		SELECT ITEM_NO, CAR_NAME, CAR_FUEL, CAR_GRADE_NAME,
		CAR_PASSENGERS, CAR_SLEEP_CAPACITY, CAR_RENT_PRICE,
		ITEM_VIEW_COUNT, 	
		(SELECT IMG_PATH || IMG_RENAME
			 FROM ITEM_IMG
			 WHERE ITEM_NO =#{itemNo}
			 AND   IMG_ORDER = 0) THUMBNAIL
		FROM CAR NATURAL JOIN ITEM 
		NATURAL JOIN CAR_GRADE
		WHERE ITEM_NO = #{itemNo}
	</select>

	<!--캠핑 용품 한 개 가져오기-->
	<select id="selectOneEquipment">
		SELECT EQUIPMENT_NAME, EQUIPMENT_RENT_PRICE, ITEM_VIEW_COUNT, EQUIPMENT_SELL_PRICE , EQUIPMENT_CATEGORY_NAME
		FROM CAMP_EQUIPMENT 
		NATURAL JOIN ITEM 
		NATURAL JOIN EQUIPMENT_CATEGORY 
		WHERE ITEM_NO = #{itemNo}
	</select>
<!--
	패키지 한 개 가져오기
	<select id="selectOnePackage" resultMap="package_rm">
		SELECT PACKAGE_PRICE, PACKAGE_ITEM_COUNT,CAR_NAME, CAR_SLEEP_CAPACITY , CAR_PASSENGERS , CAR_RENT_PRICE , CAR_FUEL , 
            IMG_PATH || IMG_RENAME "THUMBNAIL" FROM "PACKAGE"
			NATURAL JOIN PACKAGE_DETAIL 
			NATURAL JOIN ITEM 
			NATURAL JOIN CAR 
			  LEFT JOIN ITEM_IMG USING(ITEM_NO)
      <![CDATA[
         WHERE ITEM_NO IN (SELECT DISTINCT CS.ITEM_NO
                        FROM CAR_STOCK CS
                        LEFT JOIN RENT_DETAIL USING (CAR_STOCK_NO)
                        LEFT JOIN RENT USING (RENT_NO)
                        WHERE (RENT_DATE > '2024-06-14'
                        OR EXPECT_DATE < '2024-06-01'
                        OR RENT_DETAIL_NO IS NULL)
                        AND CAR_LOCATION_NO = #{carLocationNo})
      ]]>
      AND IMG_ORDER = 0 AND PACKAGE_NO = #{itemNo}
	</select>

	<select id="selectOnePackageItemList" resultType="Item">
		SELECT EQUIPMENT_NAME, EQUIPMENT_CATEGORY_NAME, EQUIPMENT_RENT_PRICE FROM CAMP_EQUIPMENT
		NATURAL JOIN EQUIPMENT_CATEGORY
		WHERE ITEM_NO IN (SELECT ITEM_NO FROM PACKAGE_DETAIL  WHERE PACKAGE_NO = #{itemNo})
	</select>-->
	
	<select id="selectCarAll">
		SELECT ITEM_NO, CATEGORY_CODE, CATEGORY_NAME, ITEM_VIEW_COUNT , CAR_NAME , 
				CAR_SLEEP_CAPACITY , CAR_PASSENGERS , CAR_RENT_PRICE , CAR_FUEL , 
				IMG_PATH || IMG_RENAME "THUMBNAIL"
		FROM CAR C
		JOIN ITEM USING (ITEM_NO)
		JOIN ITEM_CATEGORY USING (CATEGORY_CODE)
		LEFT JOIN ITEM_IMG USING(ITEM_NO)
		<![CDATA[
			WHERE ITEM_NO IN (SELECT DISTINCT CS.ITEM_NO
								FROM CAR_STOCK CS
								LEFT JOIN RENT_DETAIL USING (CAR_STOCK_NO)
								LEFT JOIN RENT USING (RENT_NO)
								WHERE (RENT_DATE > '2024-06-14'
								OR EXPECT_DATE < '2024-06-01'
								OR RENT_DETAIL_NO IS NULL)
		]]>
								<if test="carLocationNo != 0">
									AND CAR_LOCATION_NO = #{carLocationNo}
								</if>
								)
		AND IMG_ORDER = 0			
		ORDER BY 
			<!-- 최신순 -->
			<if test="sortNo == 0">
				ITEM_NO DESC
			</if>
			
			<!-- 높은 가격순 -->
			<if test="sortNo == 1">
				CAR_RENT_PRICE DESC, ITEM_NO DESC
			</if>
			
			<!-- 낮은 가격순 -->
			<if test="sortNo == 1">
				CAR_RENT_PRICE, ITEM_NO DESC
			</if>
			
			<!-- 조회수 순 -->
			<if test="sortNo == 2">
				ITEM_VIEW_COUNT DESC, ITEM_NO DESC
			</if>
	</select>

  <!--모든 캠핑용품 목록 탐색 -->
	<select id="selectCampEquipmentAll">
		SELECT ITEM_NO, CATEGORY_CODE, CATEGORY_NAME, ITEM_VIEW_COUNT,
				EQUIPMENT_CATEGORY_CODE, EQUIPMENT_CATEGORY_NAME, EQUIPMENT_NAME,
				EQUIPMENT_RENT_PRICE, EQUIPMENT_RENT_COUNT,
				EQUIPMENT_SELL_PRICE, EQUIPMENT_SELL_COUNT,
				IMG_PATH || IMG_RENAME "THUMBNAIL"
		FROM CAMP_EQUIPMENT
		JOIN EQUIPMENT_CATEGORY USING (EQUIPMENT_CATEGORY_CODE)
		JOIN ITEM USING (ITEM_NO)
		JOIN ITEM_CATEGORY USING (CATEGORY_CODE)
		LEFT JOIN ITEM_IMG USING(ITEM_NO)
	</select>
	
	<!-- 모든 패키지 목록 탐색 -->
	<select id="selectPackageAll">
		SELECT I.ITEM_NO, I.CATEGORY_CODE, CATEGORY_NAME, ITEM_VIEW_COUNT ,
				P.PACKAGE_PRICE
		FROM PACKAGE P
		JOIN ITEM I ON (P.PACKAGE_NO = I.ITEM_NO)
		JOIN ITEM_CATEGORY IC ON (IC.CATEGORY_CODE = I.CATEGORY_CODE)
		LEFT JOIN ITEM_IMG II ON (P.PACKAGE_NO = II.ITEM_NO)
	</select>


</mapper>











